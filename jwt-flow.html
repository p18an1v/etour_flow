<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>JWT Auth ‚Äî Full Explanation</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:#080c14;color:#e2e8f0;min-height:100vh;-webkit-font-smoothing:antialiased;padding-bottom:60px}
code{font-family:'JetBrains Mono',monospace;font-size:.88em;background:rgba(255,255,255,.09);padding:1px 5px;border-radius:4px}
.nav{background:#0a0f1c;border-bottom:1px solid rgba(255,255,255,.07);padding:11px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:50}
.back{font-size:12px;color:#64748b;text-decoration:none}
.nav-title{font-size:13px;font-weight:700;color:#fcd34d}
.nav-hint{font-size:10px;color:#334155;margin-left:auto}
.pills{display:flex;gap:6px;overflow-x:auto;padding:9px 14px;background:#0a0f1c;border-bottom:1px solid rgba(255,255,255,.06);scrollbar-width:none}
.pills::-webkit-scrollbar{display:none}
.pill{flex-shrink:0;font-size:10px;font-weight:700;padding:4px 11px;border-radius:20px;text-decoration:none;white-space:nowrap;border:1px solid transparent}
.page{max-width:720px;margin:0 auto;padding:18px 14px}
.intro{background:#0e1420;border:1px solid rgba(245,158,11,.25);border-radius:14px;padding:16px;margin-bottom:16px}
.intro h2{font-size:15px;font-weight:800;color:#fcd34d;margin-bottom:6px}
.intro p{font-size:12px;color:#94a3b8;line-height:1.7}
.secret-box{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.3);border-radius:12px;padding:13px 15px;margin-bottom:14px;text-align:center}
.secret-box .slbl{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#78350f;margin-bottom:7px}
.secret-box .skey{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:#fcd34d;word-break:break-all}
.secret-box p{font-size:10px;color:#92400e;margin-top:5px}
.step{margin-bottom:5px;border-radius:14px;border:1px solid rgba(255,255,255,.07);background:#0e1420;overflow:hidden}
.step.open{border-color:var(--sc,rgba(245,158,11,.3))}
.step-btn{display:flex;align-items:center;gap:12px;padding:13px 16px;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;width:100%;background:none;border:none;color:inherit;text-align:left}
.num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0}
.sico{font-size:19px;flex-shrink:0}
.si{flex:1;min-width:0}.st{font-size:13px;font-weight:700}.ss{font-size:10px;color:#64748b;margin-top:2px}
.caret{color:#334155;font-size:12px;transition:transform .2s;flex-shrink:0}
.open .caret{transform:rotate(180deg)}
.sb{display:none;padding:0 16px 16px;border-top:1px solid rgba(255,255,255,.05)}
.open .sb{display:block}
.eli5{border-radius:10px;padding:10px 13px;font-size:11px;line-height:1.65;margin-top:12px}
.lbl{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#334155;margin:13px 0 6px}
.cb{background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:11px 13px;font-size:10.5px;font-family:'JetBrains Mono',monospace;line-height:1.75;overflow-x:auto;white-space:pre}
.warn{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#fde68a;margin-top:8px;line-height:1.6}
.ok{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#86efac;margin-top:8px;line-height:1.6}
.info{background:rgba(14,165,233,.07);border:1px solid rgba(14,165,233,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#7dd3fc;margin-top:8px;line-height:1.6}
.tblw{background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:9px;overflow:hidden;margin-top:0}
.tbl{width:100%;border-collapse:collapse;font-size:10px}
.tbl th{text-align:left;padding:5px 9px;border-bottom:1px solid rgba(255,255,255,.08);font-size:9px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:#334155}
.tbl td{padding:5px 9px;border-bottom:1px solid rgba(255,255,255,.03);color:#94a3b8;vertical-align:top;line-height:1.5}
.tbl td:first-child{color:#e2e8f0;font-size:9.5px}
/* JWT visual parts */
.jpart{border-radius:9px;padding:10px 12px;font-size:11px;line-height:1.6;margin-top:6px}
.jp-h{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.25)}.jp-h .jlbl{color:#fda4af}
.jp-p{background:rgba(14,165,233,.1);border:1px solid rgba(14,165,233,.25)}.jp-p .jlbl{color:#7dd3fc}
.jp-s{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25)}.jp-s .jlbl{color:#fcd34d}
.jlbl{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
/* side compare */
.cmp{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.cmp-box{border-radius:9px;padding:10px 12px;font-size:10px;line-height:1.7}
.cmp-j{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2)}
.cmp-n{background:rgba(124,58,237,.07);border:1px solid rgba(124,58,237,.2)}
.cmp-lbl{font-size:9px;font-weight:700;text-transform:uppercase;margin-bottom:5px}
.cmp-j .cmp-lbl{color:#86efac}.cmp-n .cmp-lbl{color:#c4b5fd}
.cmp-j pre,.cmp-n pre{color:#94a3b8;white-space:pre-wrap;word-break:break-all;font-family:'JetBrains Mono',monospace}
/* step colours */
.n1{--sc:rgba(245,158,11,.35)}.n1 .num{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}.n1 .st{color:#fcd34d}.n1 .eli5{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);color:#fde68a}
.n2{--sc:rgba(34,197,94,.35)}.n2 .num{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}.n2 .st{color:#86efac}.n2 .eli5{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2);color:#86efac}
.n3{--sc:rgba(14,165,233,.35)}.n3 .num{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff}.n3 .st{color:#7dd3fc}.n3 .eli5{background:rgba(14,165,233,.07);border:1px solid rgba(14,165,233,.2);color:#7dd3fc}
.n4{--sc:rgba(139,92,246,.35)}.n4 .num{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff}.n4 .st{color:#c4b5fd}.n4 .eli5{background:rgba(139,92,246,.07);border:1px solid rgba(139,92,246,.2);color:#c4b5fd}
.n5{--sc:rgba(244,63,94,.35)}.n5 .num{background:linear-gradient(135deg,#f43f5e,#e11d48);color:#fff}.n5 .st{color:#fda4af}.n5 .eli5{background:rgba(244,63,94,.07);border:1px solid rgba(244,63,94,.2);color:#fda4af}
.n6{--sc:rgba(16,185,129,.35)}.n6 .num{background:linear-gradient(135deg,#10b981,#059669);color:#fff}.n6 .st{color:#6ee7b7}.n6 .eli5{background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);color:#6ee7b7}
.n7{--sc:rgba(100,116,139,.35)}.n7 .num{background:linear-gradient(135deg,#64748b,#475569);color:#fff}.n7 .st{color:#94a3b8}.n7 .eli5{background:rgba(100,116,139,.07);border:1px solid rgba(100,116,139,.2);color:#94a3b8}
.cmt{color:#374151}.key{color:#7dd3fc}.fn{color:#86efac}.str{color:#fcd34d}.ann{color:#fb923c}.typ{color:#c4b5fd}
footer{text-align:center;font-size:10px;color:#1e293b;padding:22px 14px}
</style>
</head>
<body>
<nav class="nav">
  <a class="back" href="index.html">‚Üê Home</a>
  <span class="nav-title">üîë JWT Auth ‚Äî Full Explanation</span>
  <span class="nav-hint">Tap to expand</span>
</nav>
<div class="pills">
  <a class="pill" href="#n1" style="background:rgba(245,158,11,.16);color:#fcd34d;border-color:rgba(245,158,11,.32)">1¬∑What is JWT</a>
  <a class="pill" href="#n2" style="background:rgba(34,197,94,.16);color:#86efac;border-color:rgba(34,197,94,.32)">2¬∑Creation</a>
  <a class="pill" href="#n3" style="background:rgba(14,165,233,.16);color:#7dd3fc;border-color:rgba(14,165,233,.32)">3¬∑Send Token</a>
  <a class="pill" href="#n4" style="background:rgba(139,92,246,.18);color:#c4b5fd;border-color:rgba(139,92,246,.35)">4¬∑Validation</a>
  <a class="pill" href="#n5" style="background:rgba(244,63,94,.18);color:#fda4af;border-color:rgba(244,63,94,.35)">5¬∑Authorization</a>
  <a class="pill" href="#n6" style="background:rgba(16,185,129,.16);color:#6ee7b7;border-color:rgba(16,185,129,.32)">6¬∑Expiry</a>
  <a class="pill" href="#n7" style="background:rgba(100,116,139,.18);color:#94a3b8;border-color:rgba(100,116,139,.32)">7¬∑Google OAuth</a>
</div>

<div class="page">
<div class="intro">
  <h2>ü§î What is JWT and why stateless?</h2>
  <p>JWT = <b>JSON Web Token</b>. After login, the server gives you a signed "ticket". Every future request includes this ticket ‚Äî the server trusts it without checking the database again. This is <b>stateless</b> ‚Äî no session stored server-side. Both Java and .NET backends use the <b>exact same secret key and algorithm</b>, making tokens interoperable.</p>
</div>

<div class="secret-box">
  <div class="slbl">üîë Shared Secret Key ‚Äî both backends use this identical string</div>
  <div class="skey">"MySecretKeyForJwt123456789012345"</div>
  <p>Algorithm: HS256 &nbsp;¬∑&nbsp; A token made by Java can be verified by .NET and vice versa</p>
</div>

<!-- AUTH vs AUTHZ terminology -->
<div style="background:#0e1420;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:12px 15px;margin-bottom:14px;font-size:11px;line-height:2">
  <b style="color:#fcd34d">Authentication</b> <span style="color:#64748b">= "Who are you?"</span> ‚Üí Is the JWT token valid + not expired?<br/>
  <b style="color:#86efac">Authorization</b> <span style="color:#64748b">= "What are you ALLOWED to do?"</span> ‚Üí Does your role permit this action?
</div>

<!-- N1 -->
<div class="step n1 open" id="n1">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">1</div><span class="sico">üß¨</span>
    <div class="si"><div class="st">JWT Structure ‚Äî 3 parts</div><div class="ss">Header.Payload.Signature ‚Äî separated by dots</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>Analogy:</b> A JWT is like a sealed envelope with your name written outside. Anyone can read the name on the envelope (payload). But only the post office (server) created the official wax seal (signature). If anyone tampers with the name, the seal breaks and is rejected.</div>
    <div class="lbl">Real JWT example ‚Äî paste into jwt.io to decode</div>
    <div class="cb" style="word-break:break-all;white-space:pre-wrap"><span style="color:#fda4af">eyJhbGciOiJIUzI1NiJ9</span>.<span style="color:#7dd3fc">eyJzdWIiOiJ1c2VyQGIuY29tIiwicm9sZSI6IkNVU1RPTUVSIiwiaWF0IjoxNzA4MzUyMDAwLCJleHAiOjE3MDg0Mzg0MDB9</span>.<span style="color:#fcd34d">aBcDeFgHiJk_signature_here</span></div>
    <div class="jpart jp-h">
      <div class="jlbl">üî¥ Part 1 ‚Äî Header (red above)</div>
      Algorithm: <b>HS256</b> (HMAC-SHA256) &nbsp;¬∑&nbsp; Type: <b>JWT</b><br/>
      Decoded: <code>{"alg":"HS256","typ":"JWT"}</code>
    </div>
    <div class="jpart jp-p">
      <div class="jlbl">üîµ Part 2 ‚Äî Payload (blue above) = the data inside the token</div>
      <code>sub</code> = user's email (who they are ‚Äî "subject")<br/>
      <code>role</code> = CUSTOMER or admin (custom claim we added)<br/>
      <code>iat</code> = issued-at timestamp (when created)<br/>
      <code>exp</code> = expiry timestamp (24 hours after creation)<br/>
      <code>type</code> = only on reset tokens ‚Äî value: "RESET_PASSWORD"
    </div>
    <div class="jpart jp-s">
      <div class="jlbl">üü° Part 3 ‚Äî Signature (gold above)</div>
      = HMAC-SHA256(<code>Base64(header) + "." + Base64(payload)</code>, secretKey)<br/>
      <b>If anyone changes even 1 character of the payload, this signature no longer matches ‚Üí token rejected!</b>
    </div>
    <div class="warn">‚ö†Ô∏è The payload is Base64 encoded, NOT encrypted. Anyone can decode and read the email and role. Never put passwords or secrets inside a JWT payload!</div>
  </div>
</div>

<!-- N2 -->
<div class="step n2" id="n2">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">2</div><span class="sico">üè≠</span>
    <div class="si"><div class="st">Token Creation ‚Äî at Login</div><div class="ss">After password verified ‚Üí server builds and signs JWT</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>After the server confirms your password is correct</b>, it creates a JWT: puts your email + role inside, sets an expiry time, and signs it with the secret key. You receive this token and store it. You will use it for every future protected request.</div>
    <div class="lbl">Side-by-side: Java vs .NET token generation</div>
    <div class="cmp">
      <div class="cmp-box cmp-j">
        <div class="cmp-lbl">‚òï Java ‚Äî JwtUtil.java</div>
        <pre>Jwts.builder()
  .setSubject(email)
  .claim("role", role)
  .setIssuedAt(new Date())
  .setExpiration(
    new Date(now + 86400000))
  .signWith(secretKey, HS256)
  .compact();</pre>
      </div>
      <div class="cmp-box cmp-n">
        <div class="cmp-lbl">üí† .NET ‚Äî JwtService.cs</div>
        <pre>new JwtSecurityToken(
  claims: [sub, role],
  expires: now + 24h,
  signingCredentials:
    new(key, HmacSha256)
);
handler.WriteToken(token);</pre>
      </div>
    </div>
    <div class="ok">Login response to frontend: <code>{"token": "eyJhbGci..."}</code></div>
    <div class="lbl">Token expiry at creation time</div>
    <div class="tblw">
      <table class="tbl">
        <tr><th>Token Type</th><th>Expiry</th><th>Extra Claim</th><th>Used For</th></tr>
        <tr><td>Login JWT</td><td>24 hours</td><td>sub=email, role=CUSTOMER</td><td>All protected API calls</td></tr>
        <tr><td>Reset Password JWT</td><td>15 minutes</td><td>type="RESET_PASSWORD"</td><td>One-time password reset link in email</td></tr>
      </table>
    </div>
  </div>
</div>

<!-- N3 -->
<div class="step n3" id="n3">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">3</div><span class="sico">üì§</span>
    <div class="si"><div class="st">Storing and Sending the Token</div><div class="ss">FE saves token, attaches to every protected request</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>Analogy:</b> After login you get a wristband üé´. You keep it in your pocket (localStorage). Every time you enter a protected area, you show the wristband ‚Äî the staff doesn't need to look you up in the database. The wristband proves who you are and what areas you're allowed in.</div>
    <div class="lbl">Step 1 ‚Äî Save token after login (Frontend JS)</div>
    <div class="cb"><span class="key">const</span> response = await fetch(<span class="str">'/api/auth/login'</span>, {
  method: <span class="str">'POST'</span>,
  headers: { <span class="str">'Content-Type'</span>: <span class="str">'application/json'</span> },
  body: JSON.stringify({ email, password })
});
<span class="key">const</span> { token } = await response.json();
localStorage.setItem(<span class="str">'jwt_token'</span>, token); <span class="cmt">// üíæ save it locally</span></div>
    <div class="lbl">Step 2 ‚Äî Attach to every protected API call</div>
    <div class="cb"><span class="key">const</span> token = localStorage.getItem(<span class="str">'jwt_token'</span>);

fetch(<span class="str">'/api/bookings/customer/5'</span>, {
  headers: {
    <span class="str">'Authorization'</span>: <span class="str">`Bearer ${token}`</span>
    <span class="cmt">// ‚Üë EXACTLY: "Bearer " (capital B, one space, then token)</span>
  }
});</div>
    <div class="lbl">What the raw HTTP request looks like</div>
    <div class="cb">GET /api/bookings/customer/5 HTTP/1.1
Host: localhost:8080
<span class="str">Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIi...</span>
Content-Type: application/json</div>
    <div class="warn">‚ö†Ô∏è If you forget "Bearer " prefix or use lowercase "bearer", the filter won't find the token. The check is: <code>header.startsWith("Bearer ")</code></div>
  </div>
</div>

<!-- N4 -->
<div class="step n4" id="n4">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">4</div><span class="sico">üîç</span>
    <div class="si"><div class="st">Server Reads and Validates Token</div><div class="ss">JwtAuthFilter (Java) / JwtMiddleware (.NET) ‚Äî runs on every request</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>Same logic, different code ‚Äî both backends:</b><br/>‚ë† Read the Authorization header<br/>‚ë° Strip "Bearer " prefix to get raw token<br/>‚ë¢ Re-sign header+payload with secret ‚Üí compare to attached signature<br/>‚ë£ Check expiry date hasn't passed<br/>‚ë§ If valid: extract email + role<br/>‚ë• Store identity so controller can read it</div>
    <div class="lbl">Java ‚Äî result stored in SecurityContextHolder</div>
    <div class="cb"><span class="cmt">// JwtAuthFilter.java ‚Äî after validation</span>
UsernamePasswordAuthenticationToken authToken =
  <span class="key">new</span> UsernamePasswordAuthenticationToken(
    email, <span class="key">null</span>,
    List.of(<span class="key">new</span> SimpleGrantedAuthority(<span class="str">"ROLE_"</span> + role)));
SecurityContextHolder.getContext().<span class="fn">setAuthentication</span>(authToken);
<span class="cmt">// Controller reads: Authentication auth param ‚Üí auth.getName() = email</span></div>
    <div class="lbl">.NET ‚Äî result stored in HttpContext.Items</div>
    <div class="cb"><span class="cmt">// JwtMiddleware.cs ‚Äî after validation</span>
ctx.Items[<span class="str">"UserEmail"</span>] = jwtService.<span class="fn">ExtractEmail</span>(token);
ctx.Items[<span class="str">"UserRole"</span>]  = jwtService.<span class="fn">ExtractRole</span>(token);
<span class="cmt">// Controller reads: HttpContext.Items["UserEmail"]?.ToString()</span></div>
    <div class="lbl">All possible scenarios ‚Äî what happens if token is missing/bad</div>
    <div class="tblw">
      <table class="tbl">
        <tr><th>Scenario</th><th>What happens</th><th>Client receives</th></tr>
        <tr><td>‚úÖ Valid token</td><td>Email + role set on context ‚Üí controller runs</td><td>200 OK + data</td></tr>
        <tr><td>‚ùå No token</td><td>Identity not set ‚Üí controller gets null user</td><td>401 Unauthorized</td></tr>
        <tr><td>‚ùå Expired token</td><td>Expiry check fails ‚Üí identity not set</td><td>401 Unauthorized</td></tr>
        <tr><td>‚ùå Tampered payload</td><td>Signature mismatch ‚Üí identity not set</td><td>401 Unauthorized</td></tr>
        <tr><td>‚ùå Wrong secret key</td><td>Signature mismatch (different key)</td><td>401 Unauthorized</td></tr>
      </table>
    </div>
  </div>
</div>

<!-- N5 -->
<div class="step n5" id="n5">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">5</div><span class="sico">üö¶</span>
    <div class="si"><div class="st">Authorization ‚Äî Role-Based Access</div><div class="ss">Who is allowed to do what ‚Äî CUSTOMER vs admin</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>Authentication</b> ("are you logged in?") already happened in Step 4. Now <b>Authorization</b> checks "are you <i>allowed</i> to do this?" Our project has two roles: <code>CUSTOMER</code> (regular user) and <code>admin</code>. A customer can only see their own bookings; an admin can see all.</div>
    <div class="lbl">Roles in our project</div>
    <div class="tblw">
      <table class="tbl">
        <tr><th>Role</th><th>Where stored</th><th>Example permissions</th></tr>
        <tr><td>CUSTOMER</td><td>customer_master.customer_role</td><td>Book tours, view own bookings, update own profile</td></tr>
        <tr><td>admin</td><td>customer_master.customer_role</td><td>View all bookings, manage tours, manage users</td></tr>
      </table>
    </div>
    <div class="lbl">Java ‚Äî role check via Spring @PreAuthorize</div>
    <div class="cb"><span class="cmt">// SecurityContext was set by JwtAuthFilter with "ROLE_CUSTOMER"</span>
<span class="ann">@PreAuthorize</span>(<span class="str">"hasRole('CUSTOMER')"</span>)
<span class="ann">@GetMapping</span>(<span class="str">"/my-bookings"</span>)
ResponseEntity getMyBookings(Authentication auth) {
  String email = auth.getName(); <span class="cmt">// from JWT "sub"</span>
  <span class="key">return</span> ResponseEntity.ok(service.<span class="fn">getByEmail</span>(email));
}

<span class="cmt">// Admin-only endpoint:</span>
<span class="ann">@PreAuthorize</span>(<span class="str">"hasRole('admin')"</span>)
<span class="ann">@GetMapping</span>(<span class="str">"/all-bookings"</span>)
ResponseEntity getAllBookings() { ... }</div>
    <div class="lbl">.NET ‚Äî role check manually in controller</div>
    <div class="cb"><span class="cmt">// HttpContext.Items was set by JwtMiddleware</span>
<span class="ann">[HttpGet(<span class="str">"my-bookings"</span>)]</span>
<span class="key">public async</span> Task&lt;IActionResult&gt; <span class="fn">GetMyBookings</span>() {
  <span class="key">var</span> role = HttpContext.Items[<span class="str">"UserRole"</span>]?.ToString();
  <span class="key">if</span> (role != <span class="str">"CUSTOMER"</span>)
    <span class="key">return</span> Unauthorized(<span class="key">new</span>{ message = <span class="str">"Customers only"</span> });

  <span class="key">var</span> email = HttpContext.Items[<span class="str">"UserEmail"</span>]?.ToString();
  <span class="key">return</span> Ok(await _service.<span class="fn">GetByEmailAsync</span>(email));
}</div>
  </div>
</div>

<!-- N6 -->
<div class="step n6" id="n6">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">6</div><span class="sico">‚è±Ô∏è</span>
    <div class="si"><div class="st">Token Expiry and Renewal</div><div class="ss">Login = 24h ¬∑ Reset = 15min ¬∑ What happens when expired</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>Tokens expire</b> ‚Äî so even if stolen, they only work for a limited time. After expiry, the client gets a 401 and must log in again to receive a fresh token.</div>
    <div class="lbl">Expiry configuration</div>
    <div class="tblw">
      <table class="tbl">
        <tr><th>Token Type</th><th>Expiry Time</th><th>Extra Claim</th><th>What happens when expired</th></tr>
        <tr><td>Login JWT</td><td>24 hours</td><td>sub + role</td><td>401 ‚Üí redirect to login page ‚Üí user logs in ‚Üí new token</td></tr>
        <tr><td>Reset Password JWT</td><td>15 minutes</td><td>type="RESET_PASSWORD"</td><td>Reset link becomes invalid ‚Üí user must request again</td></tr>
      </table>
    </div>
    <div class="lbl">Java ‚Äî expiry check in JwtUtil.isTokenValid()</div>
    <div class="cb"><span class="key">public boolean</span> <span class="fn">isTokenValid</span>(String token) {
  <span class="key">try</span> {
    Jwts.parserBuilder()
      .setSigningKey(secretKey)
      .build()
      .parseClaimsJws(token); <span class="cmt">// throws if expired or bad sig</span>
    <span class="key">return true</span>;
  } <span class="key">catch</span>(ExpiredJwtException e) { <span class="key">return false</span>; }
    <span class="key">catch</span>(JwtException e)         { <span class="key">return false</span>; }
}</div>
    <div class="lbl">.NET ‚Äî expiry check in JwtService.IsTokenValid()</div>
    <div class="cb"><span class="key">public bool</span> <span class="fn">IsTokenValid</span>(string token) {
  <span class="key">var</span> handler = <span class="key">new</span> JwtSecurityTokenHandler();
  <span class="key">var</span> key = <span class="key">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(SecretKey));
  <span class="key">try</span> {
    handler.ValidateToken(token, <span class="key">new</span> TokenValidationParameters {
      ValidateLifetime = <span class="key">true</span>,          <span class="cmt">// checks exp claim</span>
      ValidateIssuerSigningKey = <span class="key">true</span>,  <span class="cmt">// checks signature</span>
      IssuerSigningKey = key,
      ValidateIssuer = <span class="key">false</span>,
      ValidateAudience = <span class="key">false</span>
    }, out _);
    <span class="key">return true</span>;
  } <span class="key">catch</span> { <span class="key">return false</span>; }
}</div>
    <div class="ok">‚úÖ After expiry ‚Üí frontend catches 401 ‚Üí localStorage.removeItem('jwt_token') ‚Üí redirect to /login</div>
  </div>
</div>

<!-- N7 -->
<div class="step n7" id="n7">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">7</div><span class="sico">üåê</span>
    <div class="si"><div class="st">Google OAuth + JWT</div><div class="ss">Login with Google ‚Üí Google ID token ‚Üí our own JWT</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>Google OAuth doesn't replace our JWT</b> ‚Äî it's just an alternative way to verify identity. After Google confirms "this is a real Gmail account", our backend creates its own JWT. From that point, everything works exactly the same as a normal login. Google is only involved in the identity verification step.</div>
    <div class="lbl">Google OAuth Flow ‚Äî step by step</div>
    <div class="cb"><span class="cmt">// ‚ë† User clicks "Sign in with Google" on frontend</span>
<span class="cmt">// ‚ë° Google verifies their Gmail account</span>
<span class="cmt">// ‚ë¢ Google returns a Google ID Token to the frontend</span>
<span class="cmt">// ‚ë£ Frontend POSTS the Google token to our backend</span>

<span class="key">POST</span> /api/auth/google-login   (or /auth/oauth2/google in Java)
{ "idToken": "eyJGoogleToken..." }

<span class="cmt">// ‚ë§ Backend verifies Google token using Google's public API</span>
<span class="cmt">// ‚ë• Extract email from Google payload</span>
<span class="cmt">// ‚ë¶ Check/create user in customer_master table</span>
<span class="cmt">// ‚ëß Generate OUR OWN JWT (same secret key, same format)</span>
<span class="cmt">// ‚ë® Return our JWT to frontend ‚Äî works like normal login</span>

Response: { "token": "eyJhbGci..." }</div>
    <div class="info">üí° The Google token and our JWT are completely different. Google's token is only used once to verify identity. After that, we create our own JWT and Google is no longer involved. The frontend uses our JWT for all subsequent API calls.</div>
    <div class="lbl">Java ‚Äî OAuth2 success handler</div>
    <div class="cb"><span class="cmt">// OAuth2SuccessHandler.java ‚Äî called after Google confirms identity</span>
<span class="ann">@Component</span>
<span class="key">public class</span> OAuth2SuccessHandler
    <span class="key">extends</span> SimpleUrlAuthenticationSuccessHandler {

  <span class="key">public void</span> <span class="fn">onAuthenticationSuccess</span>(...) {
    String email = oAuth2User.getAttribute(<span class="str">"email"</span>);
    String role = <span class="str">"CUSTOMER"</span>;

    <span class="cmt">// Create/fetch user in DB</span>
    authService.<span class="fn">registerIfNotExists</span>(email, role);

    <span class="cmt">// Generate OUR JWT</span>
    String token = jwtUtil.<span class="fn">generateToken</span>(email, role);

    <span class="cmt">// Redirect frontend with token in URL (or cookie)</span>
    <span class="fn">getRedirectStrategy</span>().sendRedirect(req, res,
      <span class="str">"/oauth2/success?token="</span> + token);
  }
}</div>
  </div>
</div>

<!-- FULL LIFECYCLE SUMMARY -->
<div class="lbl" style="margin-top:20px">üó∫Ô∏è Complete JWT Lifecycle Summary</div>
<div style="background:#0e1420;border:1px solid rgba(245,158,11,.2);border-radius:12px;padding:14px 16px;font-size:11px;line-height:2.2">
  <div><span style="color:#fcd34d">‚ë†</span> User submits email + password ‚Üí AuthService checks BCrypt hash in DB</div>
  <div><span style="color:#fcd34d">‚ë°</span> Password matches ‚Üí JwtUtil/JwtService creates token (email+role+24h expiry, signed with secret)</div>
  <div><span style="color:#fcd34d">‚ë¢</span> <code>{"token": "eyJ..."}</code> returned ‚Üí frontend stores in <code>localStorage</code></div>
  <div><span style="color:#fcd34d">‚ë£</span> Every protected API call ‚Üí frontend adds <code>Authorization: Bearer eyJ...</code> header</div>
  <div><span style="color:#fcd34d">‚ë§</span> JwtAuthFilter/JwtMiddleware reads header ‚Üí validates signature + expiry ‚Üí extracts email + role</div>
  <div><span style="color:#fcd34d">‚ë•</span> Identity stored in SecurityContext (Java) / HttpContext.Items (.NET) ‚Üí controller reads it</div>
  <div><span style="color:#fcd34d">‚ë¶</span> Service queries DB using email ‚Üí returns data ‚Üí JSON response ‚Üí browser</div>
  <div><span style="color:#fcd34d">‚ëß</span> After 24h: token expires ‚Üí 401 response ‚Üí frontend redirects to login ‚Üí user gets fresh token</div>
</div>

</div>
<footer><a href="index.html" style="color:#334155;text-decoration:none">‚Üê Back to Home</a> &nbsp;¬∑&nbsp; JWT ¬∑ HS256 ¬∑ 24h login ¬∑ 15min reset ¬∑ Java + .NET</footer>
<script>function tog(b){b.closest('.step').classList.toggle('open')}</script>
</body>
</html>
