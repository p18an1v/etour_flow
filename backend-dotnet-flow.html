<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>.NET Core ‚Äî How a Request Works</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',sans-serif;background:#080c14;color:#e2e8f0;min-height:100vh;-webkit-font-smoothing:antialiased;padding-bottom:60px}
    code{font-family:'JetBrains Mono',monospace;font-size:.88em;background:rgba(255,255,255,.07);padding:1px 5px;border-radius:4px}
    .nav{background:#0a0f1c;border-bottom:1px solid rgba(255,255,255,.07);padding:12px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:50}
    .back{font-size:12px;color:#64748b;text-decoration:none}
    .nav-title{font-size:13px;font-weight:700;color:#c4b5fd}
    .nav-sub{font-size:10px;color:#334155;margin-left:auto}
    .page{max-width:680px;margin:0 auto;padding:20px 14px}
    .intro{background:#0e1420;border:1px solid rgba(124,58,237,.2);border-radius:14px;padding:18px;margin-bottom:20px}
    .intro h2{font-size:17px;font-weight:800;color:#c4b5fd;margin-bottom:8px}
    .intro p{font-size:12px;color:#94a3b8;line-height:1.7}
    .key-diff{background:rgba(124,58,237,.07);border:1px solid rgba(124,58,237,.2);border-radius:10px;padding:12px 14px;font-size:11px;color:#a5b4fc;line-height:1.7;margin-bottom:20px}
    .step{margin-bottom:6px;border-radius:14px;border:1px solid rgba(255,255,255,.07);background:#0e1420;overflow:hidden}
    .step.open{border-color:rgba(124,58,237,.3)}
    .step-btn{display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;width:100%;background:none;border:none;color:inherit;text-align:left}
    .num{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0}
    .step-icon{font-size:20px;flex-shrink:0}
    .step-text{flex:1}
    .step-title{font-size:13px;font-weight:700}
    .step-hint{font-size:10px;color:#64748b;margin-top:2px}
    .caret{color:#334155;transition:transform .2s;flex-shrink:0}
    .open .caret{transform:rotate(180deg)}
    .step-body{display:none;padding:0 16px 16px;border-top:1px solid rgba(255,255,255,.05)}
    .eli5{background:rgba(124,58,237,.07);border:1px solid rgba(124,58,237,.2);border-radius:10px;padding:11px 13px;font-size:11px;color:#c4b5fd;line-height:1.6;margin-top:12px}
    .eli5 strong{font-weight:700}
    .code-block{background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:11px 13px;font-size:10.5px;font-family:'JetBrains Mono',monospace;line-height:1.75;overflow-x:auto;margin-top:10px;white-space:pre}
    .lbl{font-size:9px;font-weight:700;letter-spacing:1.4px;text-transform:uppercase;color:#334155;margin:13px 0 7px}
    .warn{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#fde68a;margin-top:10px;line-height:1.6}
    .info{background:rgba(14,165,233,.07);border:1px solid rgba(14,165,233,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#7dd3fc;margin-top:10px;line-height:1.6}

    /* colours */
    .c1 .num{background:linear-gradient(135deg,#7c3aed,#6366f1);color:#fff}.c1 .step-title{color:#c4b5fd}
    .c2 .num{background:linear-gradient(135deg,#64748b,#475569);color:#fff}.c2 .step-title{color:#94a3b8}
    .c3 .num{background:linear-gradient(135deg,#f43f5e,#e11d48);color:#fff}.c3 .step-title{color:#fda4af}
    .c4 .num{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}.c4 .step-title{color:#fcd34d}
    .c5 .num{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}.c5 .step-title{color:#86efac}
    .c6 .num{background:linear-gradient(135deg,#10b981,#059669);color:#fff}.c6 .step-title{color:#6ee7b7}
    .c7 .num{background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff}.c7 .step-title{color:#7dd3fc}

    .cmt{color:#334155}.key{color:#7dd3fc}.fn{color:#86efac}.str{color:#fcd34d}
    footer{text-align:center;font-size:10px;color:#1e293b;padding:24px 14px}
  </style>
</head>
<body>

<nav class="nav">
  <a class="back" href="index.html">‚Üê Home</a>
  <span class="nav-title">üí† .NET Core Flow</span>
  <span class="nav-sub">Tap a step to expand</span>
</nav>

<div class="page">

  <div class="intro">
    <h2>ü§î How does .NET handle a request?</h2>
    <p>.NET uses a <strong>"middleware pipeline"</strong> ‚Äî think of it as an assembly line. Every request passes through each station (middleware) in order before reaching the controller. Each station can modify the request, stop it, or let it pass through.</p>
  </div>

  <div class="key-diff">
    <strong>‚òï Java vs üí† .NET ‚Äî Key Difference:</strong><br/>
    Java uses <strong>Filters</strong> (a Spring Security concept). .NET uses <strong>Middleware</strong> (registered in Program.cs in order). Same idea, different name.
  </div>

  <!-- PIPELINE ORDER -->
  <div class="lbl" style="margin-top:0">üìå The Assembly Line (Program.cs order)</div>
  <div style="background:#0e1420;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:14px;margin-bottom:20px;font-size:11px">
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;align-items:center;gap:10px"><span style="background:rgba(100,116,139,.2);color:#94a3b8;border-radius:6px;padding:4px 10px;font-size:10px;font-weight:700">1</span><span style="color:#94a3b8">LoggingMiddleware ‚Üí logs the request</span></div>
      <div style="display:flex;align-items:center;gap:10px"><span style="background:rgba(244,63,94,.18);color:#fda4af;border-radius:6px;padding:4px 10px;font-size:10px;font-weight:700">2</span><span style="color:#fda4af">ExceptionHandlingMiddleware ‚Üí catches crashes</span></div>
      <div style="display:flex;align-items:center;gap:10px"><span style="background:rgba(245,158,11,.18);color:#fcd34d;border-radius:6px;padding:4px 10px;font-size:10px;font-weight:700">3</span><span style="color:#fcd34d">JwtMiddleware ‚Üí reads &amp; validates JWT token</span></div>
      <div style="display:flex;align-items:center;gap:10px"><span style="background:rgba(34,197,94,.18);color:#86efac;border-radius:6px;padding:4px 10px;font-size:10px;font-weight:700">4</span><span style="color:#86efac">Controller ‚Üí handles the actual request</span></div>
      <div style="display:flex;align-items:center;gap:10px"><span style="background:rgba(16,185,129,.18);color:#6ee7b7;border-radius:6px;padding:4px 10px;font-size:10px;font-weight:700">5</span><span style="color:#6ee7b7">Service + EF Core ‚Üí business logic + database</span></div>
    </div>
  </div>

  <!-- STEPS -->

  <div class="step c1 open">
    <button class="step-btn" onclick="tog(this)">
      <div class="num">1</div>
      <span class="step-icon">üåê</span>
      <div class="step-text">
        <div class="step-title">Request Arrives</div>
        <div class="step-hint">Frontend or Postman sends HTTP to localhost:5000</div>
      </div>
      <span class="caret">‚ñº</span>
    </button>
    <div class="step-body">
      <div class="eli5"><strong>Same as Java:</strong> The browser or Postman creates an HTTP request with method (GET/POST), headers (Authorization), and body (JSON data). It hits our .NET server.</div>
      <div class="lbl">Example Requests</div>
      <div class="code-block"><span class="cmt">// Login (public ‚Äî no token needed)</span>
<span class="key">POST</span> http://localhost:5000/api/auth/login
Content-Type: application/json
{ "email": "user@b.com", "password": "pass123" }

<span class="cmt">// Get bookings (protected ‚Äî need token)</span>
<span class="key">GET</span> http://localhost:5000/api/bookings/customer/5
Authorization: Bearer eyJhbGci...</div>
    </div>
  </div>

  <div class="step c2">
    <button class="step-btn" onclick="tog(this)">
      <div class="num">2</div>
      <span class="step-icon">üìù</span>
      <div class="step-text">
        <div class="step-title">Logging Middleware</div>
        <div class="step-hint">LoggingMiddleware.cs ‚Äî writes every request to console</div>
      </div>
      <span class="caret">‚ñº</span>
    </button>
    <div class="step-body">
      <div class="eli5"><strong>In simple words:</strong> The first station logs every request that arrives ‚Äî "POST /auth/login arrived at 2:30pm". It then hands the request to the next station by calling <code>await _next(ctx)</code>. This is how all middleware pass to the next step.</div>
      <div class="code-block"><span class="cmt">// LoggingMiddleware.cs</span>
_logger.LogInformation(<span class="str">"‚Üí {Method} {Path}"</span>,
  ctx.Request.Method, ctx.Request.Path);  <span class="cmt">// log request</span>

await _next(ctx);  <span class="cmt">// üîë pass to next middleware</span>

_logger.LogInformation(<span class="str">"‚Üê Status: {Status}"</span>,
  ctx.Response.StatusCode);               <span class="cmt">// log response</span></div>
    </div>
  </div>

  <div class="step c3">
    <button class="step-btn" onclick="tog(this)">
      <div class="num">3</div>
      <span class="step-icon">üö®</span>
      <div class="step-text">
        <div class="step-title">Exception Handling Middleware</div>
        <div class="step-hint">ExceptionHandlingMiddleware.cs ‚Äî catches crashes anywhere</div>
      </div>
      <span class="caret">‚ñº</span>
    </button>
    <div class="step-body">
      <div class="eli5"><strong>In simple words:</strong> This is a safety net. It wraps all the remaining pipeline in a try/catch. If ANY code downstream throws an error (DB down, null reference, etc.), this catches it and sends a clean JSON error message instead of crashing the whole app.</div>
      <div class="code-block"><span class="cmt">// ExceptionHandlingMiddleware.cs</span>
try {
  await _next(context);  <span class="cmt">// run everything else</span>
}
catch (Exception ex) {
  <span class="cmt">// if something crashes anywhere downstream...</span>
  context.Response.StatusCode = 500;
  context.Response.ContentType = <span class="str">"application/json"</span>;
  await context.Response.<span class="fn">WriteAsJsonAsync</span>(new {
    message = ex.Message,
    statusCode = 500
  });
  <span class="cmt">// Client gets: {"message": "error text", "statusCode": 500}</span>
}</div>
    </div>
  </div>

  <div class="step c4">
    <button class="step-btn" onclick="tog(this)">
      <div class="num">4</div>
      <span class="step-icon">üîë</span>
      <div class="step-text">
        <div class="step-title">JWT Middleware</div>
        <div class="step-hint">JwtMiddleware.cs ‚Äî reads &amp; validates the token</div>
      </div>
      <span class="caret">‚ñº</span>
    </button>
    <div class="step-body">
      <div class="eli5"><strong>In simple words:</strong> Like a security checkpoint. It reads the <code>Authorization: Bearer &lt;token&gt;</code> header. If the token is valid, it extracts the email and role, then stores them in a "magic bag" (<code>HttpContext.Items</code>) that the controller can read later.</div>
      <div class="lbl">Public routes (skip the check)</div>
      <div class="code-block"><span class="cmt">// These routes bypass JWT ‚Äî anyone can access</span>
"/api/auth/login"
"/api/auth/register"
"/api/auth/forgot-password"
"/api/tours"
"/api/search"</div>
      <div class="lbl">JWT Validation logic</div>
      <div class="code-block"><span class="cmt">// 1. Read the header</span>
var authHeader = ctx.Request.Headers[<span class="str">"Authorization"</span>].FirstOrDefault();

<span class="cmt">// 2. Extract token (remove "Bearer ")</span>
if (authHeader?.StartsWith(<span class="str">"Bearer "</span>) == true) {
  var token = authHeader.Substring(7);

  <span class="cmt">// 3. Validate + extract from JwtService</span>
  var email = jwtService.<span class="fn">ExtractEmail</span>(token);
  var role  = jwtService.<span class="fn">ExtractRole</span>(token);

  if (email != null &amp;&amp; jwtService.<span class="fn">IsTokenValid</span>(token)) {
    <span class="cmt">// 4. Store in HttpContext so controller can read it</span>
    ctx.Items[<span class="str">"UserEmail"</span>] = email;
    ctx.Items[<span class="str">"UserRole"</span>]  = role;
  }
}
await _next(ctx);  <span class="cmt">// always continue</span></div>
      <div class="info">üí† .NET stores user identity in <code>HttpContext.Items["UserEmail"]</code> and <code>["UserRole"]</code>.<br/>‚òï Java stores it in <code>SecurityContextHolder.getContext().setAuthentication()</code>.<br/>Same purpose, different mechanism.</div>
    </div>
  </div>

  <div class="step c5">
    <button class="step-btn" onclick="tog(this)">
      <div class="num">5</div>
      <span class="step-icon">üéÆ</span>
      <div class="step-text">
        <div class="step-title">Controller</div>
        <div class="step-hint">[ApiController] ‚Äî receives request, calls Service</div>
      </div>
      <span class="caret">‚ñº</span>
    </button>
    <div class="step-body">
      <div class="eli5"><strong>In simple words:</strong> The receptionist. It receives the request, reads any data from the body (<code>[FromBody]</code>) or URL (<code>[FromRoute]</code>), calls the matching service, and sends back a response. Always returns <code>Ok()</code>, <code>BadRequest()</code>, or <code>Unauthorized()</code>.</div>
      <div class="lbl">All Controllers</div>
      <div style="background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:12px;font-size:10.5px;line-height:2">
        <div><span style="color:#fda4af">AuthController</span> ‚Üí <code>/api/auth/**</code></div>
        <div><span style="color:#7dd3fc">TourController</span> ‚Üí <code>/api/tours/**</code></div>
        <div><span style="color:#fcd34d">BookingController</span> ‚Üí <code>/api/bookings/**</code></div>
        <div><span style="color:#86efac">PassengerController</span> ‚Üí <code>/api/passengers/**</code></div>
        <div><span style="color:#c4b5fd">PaymentController</span> ‚Üí <code>/api/payments/**</code></div>
        <div><span style="color:#6ee7b7">CustomerController</span> ‚Üí <code>/api/customers/**</code></div>
      </div>
      <div class="lbl">AuthController.cs ‚Äî login</div>
      <div class="code-block"><span class="key">[HttpPost("login")]</span>
public async Task&lt;IActionResult&gt; <span class="fn">Login</span>(
    [FromBody] LoginRequestDto dto) {
  <span class="cmt">// call service ‚Äî controller doesn't do logic</span>
  var token = await _authService.<span class="fn">LoginAsync</span>(dto);

  if (token == null)
    return Unauthorized(new { message = <span class="str">"Invalid credentials"</span> });

  return Ok(new { token });  <span class="cmt">// 200 {"token": "eyJ..."}</span>
}</div>
      <div class="lbl">How controller reads who's logged in</div>
      <div class="code-block"><span class="cmt">// Read identity set by JwtMiddleware</span>
var email = HttpContext.Items[<span class="str">"UserEmail"</span>]?.ToString();
var role  = HttpContext.Items[<span class="str">"UserRole"</span>]?.ToString();</div>
    </div>
  </div>

  <div class="step c6">
    <button class="step-btn" onclick="tog(this)">
      <div class="num">6</div>
      <span class="step-icon">‚öôÔ∏è</span>
      <div class="step-text">
        <div class="step-title">Service</div>
        <div class="step-hint">Business logic ‚Äî validation, password check, token generation</div>
      </div>
      <span class="caret">‚ñº</span>
    </button>
    <div class="step-body">
      <div class="eli5"><strong>In simple words:</strong> The worker. The service does the real logic ‚Äî checking if the password is correct, generating the JWT token, calculating the booking total. It knows nothing about HTTP ‚Äî it just gets data in and returns data out.</div>
      <div class="code-block"><span class="cmt">// AuthService.cs ‚Äî login logic</span>
public async Task&lt;string?&gt; <span class="fn">LoginAsync</span>(LoginRequestDto dto) {
  <span class="cmt">// 1. Find user in DB by email</span>
  var customer = await _ctx.Customers
    .<span class="fn">FirstOrDefaultAsync</span>(c => c.Email == dto.Email);

  <span class="cmt">// 2. Verify password (BCrypt hash)</span>
  bool valid = BCrypt.Net.BCrypt.<span class="fn">Verify</span>(dto.Password, customer.Password);

  <span class="cmt">// 3. Generate JWT token</span>
  return _jwtService.<span class="fn">GenerateToken</span>(customer.Email, customer.CustomerRole);
  <span class="cmt">// returns: "eyJhbGciOiJIUzI1NiJ9..."</span>
}</div>
    </div>
  </div>

  <div class="step c7">
    <button class="step-btn" onclick="tog(this)">
      <div class="num">7</div>
      <span class="step-icon">üóÑÔ∏è</span>
      <div class="step-text">
        <div class="step-title">EF Core ‚Üí MySQL</div>
        <div class="step-hint">Entity Framework Core ‚Äî LINQ ‚Üí auto-generated SQL</div>
      </div>
      <span class="caret">‚ñº</span>
    </button>
    <div class="step-body">
      <div class="eli5"><strong>In simple words:</strong> Instead of writing raw SQL, we write C# code. EF Core translates it to SQL automatically. The result comes back as C# objects (entities), the service maps them to DTOs, and the controller returns them as JSON.</div>
      <div class="code-block"><span class="cmt">// You write this C# LINQ:</span>
await _ctx.Customers
    .<span class="fn">FirstOrDefaultAsync</span>(c => c.Email == email);

<span class="cmt">// EF Core generates this SQL:</span>
<span class="cmt">-- SELECT * FROM customer_master WHERE email = ? LIMIT 1</span></div>
      <div class="lbl" style="margin-top:14px">DB Tables mapped via AppDbContext.cs</div>
      <div style="background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:12px;font-size:10.5px;line-height:2">
        <div><code>DbSet&lt;Customer&gt;</code> ‚Üí <code>customer_master</code></div>
        <div><code>DbSet&lt;Tour&gt;</code> ‚Üí <code>tour_master</code></div>
        <div><code>DbSet&lt;Booking&gt;</code> ‚Üí <code>booking_header</code></div>
        <div><code>DbSet&lt;Payment&gt;</code> ‚Üí <code>payment_master</code></div>
        <div><code>DbSet&lt;Passenger&gt;</code> ‚Üí <code>passenger</code></div>
      </div>
    </div>
  </div>

</div>

<footer><a href="index.html" style="color:#334155;text-decoration:none">‚Üê Back to Home</a> &nbsp;¬∑&nbsp; BackEnd_Dotnet ¬∑ ASP.NET Core 8 ¬∑ EF Core ¬∑ MySQL</footer>

<script>
  function tog(btn){btn.closest('.step').classList.toggle('open')}
</script>
</body>
</html>
