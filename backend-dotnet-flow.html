<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>.NET Core ‚Äî Full Request Flow</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:#080c14;color:#e2e8f0;min-height:100vh;-webkit-font-smoothing:antialiased;padding-bottom:60px}
code{font-family:'JetBrains Mono',monospace;font-size:.88em;background:rgba(255,255,255,.09);padding:1px 5px;border-radius:4px}
.nav{background:#0a0f1c;border-bottom:1px solid rgba(255,255,255,.07);padding:11px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:50}
.back{font-size:12px;color:#64748b;text-decoration:none}
.nav-title{font-size:13px;font-weight:700;color:#c4b5fd}
.nav-hint{font-size:10px;color:#334155;margin-left:auto}
.pills{display:flex;gap:6px;overflow-x:auto;padding:9px 14px;background:#0a0f1c;border-bottom:1px solid rgba(255,255,255,.06);scrollbar-width:none}
.pills::-webkit-scrollbar{display:none}
.pill{flex-shrink:0;font-size:10px;font-weight:700;padding:4px 11px;border-radius:20px;text-decoration:none;white-space:nowrap;border:1px solid transparent}
.page{max-width:720px;margin:0 auto;padding:18px 14px}
.intro{background:#0e1420;border:1px solid rgba(124,58,237,.25);border-radius:14px;padding:16px;margin-bottom:16px}
.intro h2{font-size:15px;font-weight:800;color:#c4b5fd;margin-bottom:6px}
.intro p{font-size:12px;color:#94a3b8;line-height:1.7}
.step{margin-bottom:5px;border-radius:14px;border:1px solid rgba(255,255,255,.07);background:#0e1420;overflow:hidden}
.step.open{border-color:var(--sc,rgba(124,58,237,.3))}
.step-btn{display:flex;align-items:center;gap:12px;padding:13px 16px;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;width:100%;background:none;border:none;color:inherit;text-align:left}
.num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0}
.sico{font-size:19px;flex-shrink:0}
.si{flex:1;min-width:0}.st{font-size:13px;font-weight:700}.ss{font-size:10px;color:#64748b;margin-top:2px}
.caret{color:#334155;font-size:12px;transition:transform .2s;flex-shrink:0}
.open .caret{transform:rotate(180deg)}
.sb{display:none;padding:0 16px 16px;border-top:1px solid rgba(255,255,255,.05)}
.open .sb{display:block}
.eli5{border-radius:10px;padding:10px 13px;font-size:11px;line-height:1.65;margin-top:12px}
.lbl{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#334155;margin:13px 0 6px}
.cb{background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:9px;padding:11px 13px;font-size:10.5px;font-family:'JetBrains Mono',monospace;line-height:1.75;overflow-x:auto;white-space:pre}
.warn{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#fde68a;margin-top:8px;line-height:1.6}
.ok{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#86efac;margin-top:8px;line-height:1.6}
.info{background:rgba(14,165,233,.07);border:1px solid rgba(14,165,233,.2);border-radius:9px;padding:10px 12px;font-size:10.5px;color:#7dd3fc;margin-top:8px;line-height:1.6}
.tblw{background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:9px;overflow:hidden;margin-top:0}
.tbl{width:100%;border-collapse:collapse;font-size:10px}
.tbl th{text-align:left;padding:5px 9px;border-bottom:1px solid rgba(255,255,255,.08);font-size:9px;text-transform:uppercase;letter-spacing:1px;font-weight:700;color:#334155}
.tbl td{padding:5px 9px;border-bottom:1px solid rgba(255,255,255,.03);color:#94a3b8;vertical-align:top;line-height:1.5}
.tbl td:first-child{color:#e2e8f0;font-family:'JetBrains Mono',monospace;font-size:9.5px}
/* DIFF banner */
.diff-banner{background:rgba(124,58,237,.07);border:1px solid rgba(124,58,237,.22);border-radius:11px;padding:11px 14px;font-size:11px;color:#c4b5fd;line-height:1.7;margin-bottom:14px}
/* step colours */
.s1{--sc:rgba(124,58,237,.35)}.s1 .num{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff}.s1 .st{color:#c4b5fd}.s1 .eli5{background:rgba(124,58,237,.07);border:1px solid rgba(124,58,237,.2);color:#c4b5fd}
.s2{--sc:rgba(100,116,139,.35)}.s2 .num{background:linear-gradient(135deg,#64748b,#475569);color:#fff}.s2 .st{color:#94a3b8}.s2 .eli5{background:rgba(100,116,139,.07);border:1px solid rgba(100,116,139,.2);color:#94a3b8}
.s3{--sc:rgba(244,63,94,.35)}.s3 .num{background:linear-gradient(135deg,#f43f5e,#e11d48);color:#fff}.s3 .st{color:#fda4af}.s3 .eli5{background:rgba(244,63,94,.07);border:1px solid rgba(244,63,94,.2);color:#fda4af}
.s4{--sc:rgba(245,158,11,.35)}.s4 .num{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}.s4 .st{color:#fcd34d}.s4 .eli5{background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);color:#fde68a}
.s5{--sc:rgba(34,197,94,.35)}.s5 .num{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff}.s5 .st{color:#86efac}.s5 .eli5{background:rgba(34,197,94,.07);border:1px solid rgba(34,197,94,.2);color:#86efac}
.s6{--sc:rgba(16,185,129,.35)}.s6 .num{background:linear-gradient(135deg,#10b981,#059669);color:#fff}.s6 .st{color:#6ee7b7}.s6 .eli5{background:rgba(16,185,129,.07);border:1px solid rgba(16,185,129,.2);color:#6ee7b7}
.cmt{color:#374151}.key{color:#7dd3fc}.fn{color:#86efac}.str{color:#fcd34d}.ann{color:#fb923c}.typ{color:#c4b5fd}
footer{text-align:center;font-size:10px;color:#1e293b;padding:22px 14px}
</style>
</head>
<body>
<nav class="nav">
  <a class="back" href="index.html">‚Üê Home</a>
  <span class="nav-title">üí† .NET Core ‚Äî Full Flow</span>
  <span class="nav-hint">Tap to expand</span>
</nav>
<div class="pills">
  <a class="pill" href="#s1" style="background:rgba(124,58,237,.18);color:#c4b5fd;border-color:rgba(124,58,237,.35)">1¬∑Request</a>
  <a class="pill" href="#s2" style="background:rgba(100,116,139,.18);color:#94a3b8;border-color:rgba(100,116,139,.35)">2¬∑Logging</a>
  <a class="pill" href="#s3" style="background:rgba(244,63,94,.18);color:#fda4af;border-color:rgba(244,63,94,.35)">3¬∑Exception</a>
  <a class="pill" href="#s4" style="background:rgba(245,158,11,.16);color:#fcd34d;border-color:rgba(245,158,11,.32)">4¬∑JwtMiddleware</a>
  <a class="pill" href="#s5" style="background:rgba(34,197,94,.16);color:#86efac;border-color:rgba(34,197,94,.32)">5¬∑Controller</a>
  <a class="pill" href="#s6" style="background:rgba(16,185,129,.16);color:#6ee7b7;border-color:rgba(16,185,129,.32)">6¬∑Service+EF</a>
</div>
<div class="page">

<div class="intro">
  <h2>ü§î How does ASP.NET Core handle a request?</h2>
  <p>ASP.NET Core uses a <b>middleware pipeline</b> ‚Äî like an assembly line. Every request passes through each station in order. Each station can read/modify the request, stop it, or let it pass by calling <code>await _next(ctx)</code>.</p>
</div>

<div class="diff-banner">
  <b>‚òï Java vs üí† .NET ‚Äî Key Concept Difference</b><br/>
  Java uses <b>Filters</b> (Spring Security concept ‚Äî added via <code>addFilterBefore()</code>).<br/>
  .NET uses <b>Middleware</b> (registered in <code>Program.cs</code> in exact order).<br/>
  Same purpose ‚Äî intercept every request ‚Äî different name and different configuration style.
</div>

<!-- STACK OVERVIEW -->
<div class="lbl" style="margin-top:0">üìå Stack Overview</div>
<div class="tblw" style="margin-bottom:14px">
  <table class="tbl">
    <tr><th>Layer / File</th><th>What it does</th></tr>
    <tr><td>Program.cs</td><td>App startup ‚Äî registers all middleware in order, DB connection, DI</td></tr>
    <tr><td>LoggingMiddleware.cs</td><td>Logs every request + response status to console</td></tr>
    <tr><td>ExceptionHandlingMiddleware.cs</td><td>Global try/catch ‚Äî returns clean JSON error instead of crashing</td></tr>
    <tr><td>JwtMiddleware.cs</td><td>Reads Authorization header, validates JWT, sets HttpContext.Items</td></tr>
    <tr><td>JwtService.cs</td><td>GenerateToken / GenerateResetToken / ValidateToken / ExtractEmail</td></tr>
    <tr><td>AuthController.cs</td><td>Routes /api/auth/** ‚Äî register, login, forgot/reset password, Google</td></tr>
    <tr><td>AuthService.cs</td><td>Business logic ‚Äî BCrypt check, token generation</td></tr>
    <tr><td>AppDbContext.cs</td><td>Entity Framework Core ‚Äî maps C# classes to MySQL tables</td></tr>
  </table>
</div>

<!-- PIPELINE ORDER -->
<div class="lbl">üìå Middleware Pipeline (Program.cs order)</div>
<div style="background:#0e1420;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:13px 15px;margin-bottom:14px;font-size:11px;color:#64748b;line-height:2.1">
  <span style="color:#94a3b8">üåê Request</span> ‚Üí
  <span style="color:#94a3b8">LoggingMiddleware</span> ‚Üí
  <span style="color:#fda4af">ExceptionHandlingMiddleware</span> ‚Üí
  <span style="color:#fcd34d">JwtMiddleware</span> ‚Üí
  <span style="color:#86efac">Controller</span> ‚Üí
  <span style="color:#6ee7b7">Service</span> ‚Üí
  <span style="color:#5eead4">EF Core</span> ‚Üí
  <b style="color:#7dd3fc">MySQL</b><br/>
  <b style="color:#94a3b8">‚Ü© Back:</b> MySQL ‚Üí Entity ‚Üí DTO ‚Üí IActionResult.Ok(dto) ‚Üí JSON ‚Üí Browser
</div>

<!-- S1 -->
<div class="step s1 open" id="s1">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">1</div><span class="sico">üåê</span>
    <div class="si"><div class="st">HTTP Request Arrives</div><div class="ss">Frontend / Postman sends JSON to port 5000</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>In simple words:</b> Same as Java ‚Äî the browser/Postman packages an action as HTTP. Method + URL + headers + JSON body. Hits ASP.NET Core on port 5000. The Kestrel web server receives it and starts the middleware pipeline.</div>
    <div class="lbl">Example Requests</div>
    <div class="cb"><span class="cmt">// ‚ë† Public ‚Äî no token needed</span>
<span class="key">POST</span> http://localhost:5000/api/auth/login
Content-Type: application/json
{ "email": "user@b.com", "password": "pass123" }

<span class="cmt">// ‚ë° Protected ‚Äî must include JWT</span>
<span class="key">GET</span> http://localhost:5000/api/bookings/customer/5
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...

<span class="cmt">// ‚ë¢ Protected ‚Äî POST booking</span>
<span class="key">POST</span> http://localhost:5000/api/bookings
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
{ "tourId": 5, "departureId": 2, "customerId": 10 }</div>
    <div class="lbl">Program.cs ‚Äî Middleware registration order</div>
    <div class="cb"><span class="cmt">// Every middleware is registered HERE in exact order</span>
app.<span class="fn">UseMiddleware</span>&lt;<span class="typ">LoggingMiddleware</span>&gt;();           <span class="cmt">// ‚ë† first</span>
app.<span class="fn">UseMiddleware</span>&lt;<span class="typ">ExceptionHandlingMiddleware</span>&gt;(); <span class="cmt">// ‚ë° second</span>
app.<span class="fn">UseMiddleware</span>&lt;<span class="typ">JwtMiddleware</span>&gt;();              <span class="cmt">// ‚ë¢ third</span>
app.<span class="fn">UseRouting</span>();
app.<span class="fn">MapControllers</span>();                             <span class="cmt">// ‚ë£ controllers last</span></div>
  </div>
</div>

<!-- S2 -->
<div class="step s2" id="s2">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">2</div><span class="sico">üìù</span>
    <div class="si"><div class="st">Logging Middleware</div><div class="ss">LoggingMiddleware.cs ‚Äî logs every request to console</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>In simple words:</b> First station. Writes the request to console: "POST /auth/login arrived". Then calls <code>await _next(ctx)</code> to pass to the next middleware. After everything else finishes, it logs the response status code. Every middleware must call <code>_next</code> to continue the chain.</div>
    <div class="lbl">LoggingMiddleware.cs</div>
    <div class="cb"><span class="key">public class</span> <span class="typ">LoggingMiddleware</span> {
  <span class="key">private readonly</span> RequestDelegate _next;
  <span class="key">private readonly</span> ILogger&lt;<span class="typ">LoggingMiddleware</span>&gt; _logger;

  <span class="key">public async</span> Task <span class="fn">InvokeAsync</span>(HttpContext ctx) {
    <span class="cmt">// Log before</span>
    _logger.LogInformation(<span class="str">"‚Üí {Method} {Path}"</span>,
      ctx.Request.Method, ctx.Request.Path);

    await _next(ctx);  <span class="cmt">// üîë pass to next middleware (Exception handler)</span>

    <span class="cmt">// Log after (has response status now)</span>
    _logger.LogInformation(<span class="str">"‚Üê {Status} {Path}"</span>,
      ctx.Response.StatusCode, ctx.Request.Path);
  }
}</div>
  </div>
</div>

<!-- S3 -->
<div class="step s3" id="s3">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">3</div><span class="sico">üö®</span>
    <div class="si"><div class="st">Exception Handling Middleware</div><div class="ss">ExceptionHandlingMiddleware.cs ‚Äî global try/catch safety net</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>In simple words:</b> A safety net. It wraps everything downstream in a try/catch. If ANY code (service, DB, controller) throws an exception, this catches it and sends a clean JSON error to the client instead of crashing the app or leaking a stack trace.</div>
    <div class="lbl">ExceptionHandlingMiddleware.cs</div>
    <div class="cb"><span class="key">public async</span> Task <span class="fn">InvokeAsync</span>(HttpContext ctx) {
  <span class="key">try</span> {
    await _next(ctx);  <span class="cmt">// run jwt middleware + controller + service</span>
  }
  <span class="key">catch</span> (Exception ex) {
    <span class="cmt">// Something crashed anywhere downstream ‚Äî handle it here</span>
    _logger.LogError(ex, <span class="str">"Unhandled exception"</span>);
    ctx.Response.StatusCode = 500;
    ctx.Response.ContentType = <span class="str">"application/json"</span>;
    await ctx.Response.<span class="fn">WriteAsJsonAsync</span>(<span class="key">new</span> {
      message = ex.Message,
      statusCode = 500
    });
    <span class="cmt">// Client sees: {"message": "Object ref not set", "statusCode": 500}</span>
    <span class="cmt">// instead of a raw HTML crash page</span>
  }
}</div>
    <div class="info">üí° Because this wraps ALL downstream middleware, even errors in JwtMiddleware, controllers, or services are caught here ‚Äî one place for all error handling.</div>
  </div>
</div>

<!-- S4 -->
<div class="step s4" id="s4">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">4</div><span class="sico">üîë</span>
    <div class="si"><div class="st">JWT Middleware + JwtService</div><div class="ss">JwtMiddleware.cs ‚Äî validates token, stores identity in HttpContext</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>In simple words:</b> The security checkpoint. Reads <code>Authorization: Bearer &lt;token&gt;</code>. If valid, extracts email + role and stores them in <code>HttpContext.Items</code> ‚Äî a "bag" that travels with the request so controllers can read it later. Always calls <code>_next</code> so the request continues even without a token (controllers do their own role checks).</div>
    <div class="lbl">Public routes that skip JWT check</div>
    <div class="cb"><span class="cmt">// These routes can be accessed without a token</span>
<span class="key">private static readonly</span> string[] PublicRoutes = {
  <span class="str">"/api/auth/login"</span>,
  <span class="str">"/api/auth/register"</span>,
  <span class="str">"/api/auth/forgot-password"</span>,
  <span class="str">"/api/tours"</span>,
  <span class="str">"/api/search"</span>
};</div>
    <div class="lbl">JwtMiddleware.cs ‚Äî full InvokeAsync()</div>
    <div class="cb"><span class="key">public async</span> Task <span class="fn">InvokeAsync</span>(HttpContext ctx, <span class="typ">JwtService</span> jwtService) {
  <span class="cmt">// 1. Skip check for public routes</span>
  <span class="key">var</span> path = ctx.Request.Path.Value?.ToLower();
  <span class="key">if</span> (PublicRoutes.Any(r => path?.StartsWith(r) == <span class="key">true</span>)) {
    await _next(ctx); <span class="key">return</span>;
  }

  <span class="cmt">// 2. Read Authorization header</span>
  <span class="key">var</span> authHeader = ctx.Request.Headers[<span class="str">"Authorization"</span>].FirstOrDefault();

  <span class="key">if</span> (authHeader?.StartsWith(<span class="str">"Bearer "</span>) == <span class="key">true</span>) {
    <span class="key">var</span> token = authHeader.Substring(7);  <span class="cmt">// strip "Bearer "</span>

    <span class="cmt">// 3. Validate and extract</span>
    <span class="key">if</span> (jwtService.<span class="fn">IsTokenValid</span>(token)) {
      <span class="key">var</span> email = jwtService.<span class="fn">ExtractEmail</span>(token);
      <span class="key">var</span> role  = jwtService.<span class="fn">ExtractRole</span>(token);

      <span class="cmt">// 4. Store in HttpContext ‚Äî controllers read from here</span>
      ctx.Items[<span class="str">"UserEmail"</span>] = email;
      ctx.Items[<span class="str">"UserRole"</span>]  = role;
    }
  }

  await _next(ctx); <span class="cmt">// always continue</span>
}</div>
    <div class="lbl">JwtService.cs ‚Äî token generation + extraction</div>
    <div class="cb"><span class="cmt">// Same secret key as Java!</span>
<span class="key">private const string</span> SecretKey = <span class="str">"MySecretKeyForJwt123456789012345"</span>;

<span class="cmt">// Login token ‚Äî 24 hours</span>
<span class="key">public string</span> <span class="fn">GenerateToken</span>(string email, string role) {
  <span class="key">var</span> claims = <span class="key">new</span>[] {
    <span class="key">new</span> Claim(JwtRegisteredClaimNames.Sub, email),
    <span class="key">new</span> Claim(<span class="str">"role"</span>, role)
  };
  <span class="key">var</span> key   = <span class="key">new</span> SymmetricSecurityKey(Encoding.UTF8.GetBytes(SecretKey));
  <span class="key">var</span> creds = <span class="key">new</span> SigningCredentials(key, SecurityAlgorithms.HmacSha256);
  <span class="key">var</span> token = <span class="key">new</span> JwtSecurityToken(
    claims: claims,
    expires: DateTime.UtcNow.AddHours(24),  <span class="cmt">// 24 hours</span>
    signingCredentials: creds
  );
  <span class="key">return new</span> JwtSecurityTokenHandler().<span class="fn">WriteToken</span>(token);
}

<span class="cmt">// Reset token ‚Äî only 15 minutes</span>
<span class="key">public string</span> <span class="fn">GenerateResetToken</span>(string email) {
  <span class="cmt">// Same as above but expires: DateTime.UtcNow.AddMinutes(15)</span>
  <span class="cmt">// and includes claim("type", "RESET_PASSWORD")</span>
}

<span class="key">public string?</span> <span class="fn">ExtractEmail</span>(string token) { ... }  <span class="cmt">// reads "sub" claim</span>
<span class="key">public string?</span> <span class="fn">ExtractRole</span>(string token)  { ... }  <span class="cmt">// reads "role" claim</span>
<span class="key">public bool</span>    <span class="fn">IsTokenValid</span>(string token) { ... }  <span class="cmt">// verifies signature + expiry</span></div>
    <div class="info">üí† .NET stores user identity in <code>HttpContext.Items["UserEmail"]</code>.<br/>‚òï Java stores it in <code>SecurityContextHolder.getContext().getAuthentication()</code>.<br/>Same idea ‚Äî different mechanism.</div>
  </div>
</div>

<!-- S5 -->
<div class="step s5" id="s5">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">5</div><span class="sico">üéÆ</span>
    <div class="si"><div class="st">Controller Layer</div><div class="ss">[ApiController] ‚Äî routes HTTP, reads body/params, calls Service</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>In simple words:</b> The receptionist. Reads data from the HTTP request (<code>[FromBody]</code>, <code>[FromRoute]</code>, <code>[FromQuery]</code>), delegates to service, returns <code>Ok()</code>, <code>BadRequest()</code>, or <code>Unauthorized()</code>. No business logic here.</div>
    <div class="lbl">All Controllers</div>
    <div class="tblw">
      <table class="tbl">
        <tr><th>Controller</th><th>Route</th><th>Key Endpoints</th></tr>
        <tr><td>AuthController</td><td>/api/auth/**</td><td>POST /register, /login, /forgot-password, /reset-password, /google-login</td></tr>
        <tr><td>TourController</td><td>/api/tours/**</td><td>GET /all, GET /{id}, GET /scheduled, GET /search</td></tr>
        <tr><td>CategoryController</td><td>/api/categories/**</td><td>GET /all, GET /sub/{catCode}</td></tr>
        <tr><td>BookingController</td><td>/api/bookings/**</td><td>POST /, GET /customer/{id}, GET /{id}, PUT /status</td></tr>
        <tr><td>PassengerController</td><td>/api/passengers/**</td><td>POST /add, GET /booking/{id}</td></tr>
        <tr><td>PaymentController</td><td>/api/payments/**</td><td>POST /create, GET /booking/{id}</td></tr>
        <tr><td>CustomerController</td><td>/api/customers/**</td><td>GET /profile, PUT /update</td></tr>
      </table>
    </div>
    <div class="lbl">AuthController.cs ‚Äî Register + Login</div>
    <div class="cb"><span class="ann">[ApiController]</span>
<span class="ann">[Route(<span class="str">"api/auth"</span>)]</span>
<span class="key">public class</span> <span class="typ">AuthController</span> : ControllerBase {

  <span class="ann">[HttpPost(<span class="str">"register"</span>)]</span>
  <span class="key">public async</span> Task&lt;IActionResult&gt; <span class="fn">Register</span>([FromBody] RegisterDto dto) {
    <span class="key">var</span> result = await _authService.<span class="fn">RegisterAsync</span>(dto);
    <span class="key">return</span> Ok(<span class="key">new</span> { message = result });
  }

  <span class="ann">[HttpPost(<span class="str">"login"</span>)]</span>
  <span class="key">public async</span> Task&lt;IActionResult&gt; <span class="fn">Login</span>([FromBody] LoginDto dto) {
    <span class="key">var</span> token = await _authService.<span class="fn">LoginAsync</span>(dto);
    <span class="key">if</span> (token == <span class="key">null</span>) <span class="key">return</span> Unauthorized(<span class="key">new</span>{ message = <span class="str">"Invalid credentials"</span> });
    <span class="key">return</span> Ok(<span class="key">new</span> { token });
    <span class="cmt">// ‚Üí 200 {"token": "eyJhbGci..."}</span>
  }

  <span class="ann">[HttpPost(<span class="str">"forgot-password"</span>)]</span>
  <span class="key">public async</span> Task&lt;IActionResult&gt; <span class="fn">ForgotPassword</span>([FromBody] ForgotPasswordDto dto){
    await _authService.<span class="fn">ForgotPasswordAsync</span>(dto.Email);
    <span class="key">return</span> Ok(<span class="key">new</span>{ message = <span class="str">"Reset link sent"</span> });
  }

  <span class="ann">[HttpPost(<span class="str">"reset-password"</span>)]</span>
  <span class="key">public async</span> Task&lt;IActionResult&gt; <span class="fn">ResetPassword</span>([FromBody] ResetPasswordDto dto){
    await _authService.<span class="fn">ResetPasswordAsync</span>(dto);
    <span class="key">return</span> Ok(<span class="key">new</span>{ message = <span class="str">"Password updated"</span> });
  }
}</div>
    <div class="lbl">How a controller reads who is logged in</div>
    <div class="cb"><span class="cmt">// Read identity set by JwtMiddleware earlier in pipeline</span>
<span class="key">var</span> email = HttpContext.Items[<span class="str">"UserEmail"</span>]?.ToString();
<span class="key">var</span> role  = HttpContext.Items[<span class="str">"UserRole"</span>]?.ToString();

<span class="key">if</span> (role != <span class="str">"CUSTOMER"</span>) <span class="key">return</span> Unauthorized();
<span class="cmt">// Only CUSTOMER role can proceed</span></div>
  </div>
</div>

<!-- S6 -->
<div class="step s6" id="s6">
  <button class="step-btn" onclick="tog(this)">
    <div class="num">6</div><span class="sico">‚öôÔ∏è</span>
    <div class="si"><div class="st">Service ‚Üí EF Core ‚Üí MySQL ‚Üí Response</div><div class="ss">Business logic ‚Üí LINQ ‚Üí auto-SQL ‚Üí DTO ‚Üí JSON back</div></div>
    <span class="caret">‚ñº</span>
  </button>
  <div class="sb">
    <div class="eli5"><b>In simple words:</b> Service does real work ‚Äî BCrypt password check, token generation. It uses EF Core to query the DB using C# LINQ instead of raw SQL. EF Core auto-generates the SQL. Results come back as C# entities, get mapped to DTOs, and the controller returns them as JSON.</div>
    <div class="lbl">AuthService.cs ‚Äî full LoginAsync()</div>
    <div class="cb"><span class="key">public async</span> Task&lt;string?&gt; <span class="fn">LoginAsync</span>(LoginDto dto) {
  <span class="cmt">// 1. Find customer by email (EF Core ‚Üí SQL)</span>
  <span class="key">var</span> customer = await _ctx.Customers
    .<span class="fn">FirstOrDefaultAsync</span>(c => c.Email == dto.Email);
  <span class="cmt">// ‚Üí SELECT * FROM customer_master WHERE email = ? LIMIT 1</span>

  <span class="key">if</span> (customer == <span class="key">null</span>) <span class="key">return null</span>;

  <span class="cmt">// 2. Verify BCrypt hash</span>
  <span class="key">bool</span> valid = BCrypt.Net.BCrypt.<span class="fn">Verify</span>(dto.Password, customer.Password);
  <span class="key">if</span> (!valid) <span class="key">return null</span>;

  <span class="cmt">// 3. Generate JWT with email + role</span>
  <span class="key">return</span> _jwtService.<span class="fn">GenerateToken</span>(customer.Email, customer.CustomerRole);
  <span class="cmt">// Returns: "eyJhbGciOiJIUzI1NiJ9..."</span>
}</div>
    <div class="lbl">AppDbContext.cs ‚Äî all DbSet mappings</div>
    <div class="tblw">
      <table class="tbl">
        <tr><th>DbSet (C#)</th><th>Entity Class</th><th>DB Table</th></tr>
        <tr><td>Customers</td><td>Customer</td><td>customer_master</td></tr>
        <tr><td>Tours</td><td>Tour</td><td>tour_master</td></tr>
        <tr><td>Categories</td><td>Category</td><td>category_master</td></tr>
        <tr><td>DepartureDates</td><td>DepartureDate</td><td>departure_master</td></tr>
        <tr><td>Bookings</td><td>Booking</td><td>booking_header</td></tr>
        <tr><td>Passengers</td><td>Passenger</td><td>passenger</td></tr>
        <tr><td>Payments</td><td>Payment</td><td>payment_master</td></tr>
      </table>
    </div>
    <div class="lbl">EF Core LINQ ‚Üí auto SQL</div>
    <div class="cb"><span class="cmt">// You write LINQ (C#):</span>
await _ctx.Customers.<span class="fn">FirstOrDefaultAsync</span>(c => c.Email == email);
await _ctx.Bookings .<span class="fn">Where</span>(b => b.CustomerId == id).<span class="fn">ToListAsync</span>();
await _ctx.Tours    .<span class="fn">Where</span>(t => t.CategoryCode == code).<span class="fn">ToListAsync</span>();

<span class="cmt">// EF Core generates SQL automatically:</span>
<span class="cmt">-- SELECT * FROM customer_master WHERE email = ? LIMIT 1</span>
<span class="cmt">-- SELECT * FROM booking_header WHERE customer_id = ?</span>
<span class="cmt">-- SELECT * FROM tour_master WHERE category_code = ?</span></div>
    <div class="ok">‚úÖ <b>Full response path:</b> MySQL ‚Üí EF Core Entity ‚Üí Service maps to DTO ‚Üí Controller returns <code>Ok(dto)</code> ‚Üí JSON serialized ‚Üí HTTP 200 ‚Üí Browser/App</div>
  </div>
</div>

</div>
<footer><a href="index.html" style="color:#334155;text-decoration:none">‚Üê Back to Home</a> &nbsp;¬∑&nbsp; .NET 8 ¬∑ ASP.NET Core ¬∑ EF Core ¬∑ MySQL</footer>
<script>function tog(b){b.closest('.step').classList.toggle('open')}</script>
</body>
</html>
